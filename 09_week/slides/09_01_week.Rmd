---
title: "Proportions and Nested Proportions"
subtitle: "Parts-to-whole arguments and conditional composition"
author: "Jared Edgerton"
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts, plsc498.css]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: ""
---

class: center, middle, inverse, title-slide

.title[
# Proportions and Nested Proportions
]
.subtitle[
## Parts-to-whole arguments and conditional composition
]
.author[
### Jared Edgerton
]

---

# Quiz on canvas

- Log on to the course website to take it.
- You have 10 minutes.
- It is open notes and web.
- Do not generate your answers with AI.

---

# Quick Recap

- Last time, we focused on:
  - ECDFs (fewer tuning knobs)
  - Qâ€“Q plots (diagnosing departures from normal)
  - many distributions at once (box/violin/points)
  - multipanel figures (facets)

Today, we focus on **composition**:

- parts-to-whole reasoning (what is the denominator?)
- stacked vs side-by-side comparisons
- when (and when not) to use pies
- nested proportions (parts within parts)

---

# Simulated data for today

```{r, message=FALSE, warning=FALSE}
library(ggplot2); library(dplyr); library(tidyr); library(forcats); library(scales)
set.seed(123)
n <- 2500
df <- tibble(
  id = 1:n,
  party = sample(c("Democrat", "Independent", "Republican"), size = n, replace = TRUE, prob = c(0.43, 0.17, 0.40)),
  education = sample(c("HS or less", "Some college", "BA", "Graduate"), size = n, replace = TRUE, prob = c(0.33, 0.30, 0.22, 0.15)),
  region = sample(c("Northeast", "Midwest", "South", "West"), size = n, replace = TRUE, prob = c(0.18, 0.21, 0.40, 0.21)),
  wave = sample(paste0("Wave ", 1:4), size = n, replace = TRUE))
df <- df %>%
  mutate(
    educ_num = as.numeric(factor(education, levels = c("HS or less", "Some college", "BA", "Graduate"))),
    wave_num = as.numeric(factor(wave, levels = paste0("Wave ", 1:4))),
    base_support = case_when(party == "Democrat" ~ 0.62, party == "Independent" ~ 0.50, party == "Republican" ~ 0.38),
    p_support = pmin(pmax(base_support + (educ_num - 2.5) * 0.04 + (wave_num - 2.5) * 0.02 + rnorm(n, 0, 0.03), 0.05), 0.90),
    p_neutral = 0.18,
    p_oppose = 1 - p_support - p_neutral,
    u = runif(n),
    attitude = case_when(u < p_support ~ "Support", u < p_support + p_neutral ~ "Neutral", TRUE ~ "Oppose"),
    college = if_else(education %in% c("BA", "Graduate"), "College", "No college")
  ) %>%
  dplyr::select(-educ_num, -wave_num, -base_support, -p_support, -p_neutral, -p_oppose, -u)
```

---

# Inspect data

```{r, message=FALSE, warning=FALSE}
df %>% 
  slice(1:10)

```

---

# Parts-to-whole reasoning

When you plot proportions, you are making a claim about a **denominator**.

Two questions to ask *before* you plot:

- What is the "whole"?
- Within which group(s) are we computing shares?

---

# Example: counts (party)

```{r, message=FALSE, warning=FALSE, fig.width=6, fig.height=3.2}
party_counts <- df %>%
  count(party) %>%
  mutate(party = fct_infreq(party))
ggplot(party_counts, aes(x = party, y = n)) +
  geom_col() +
  theme_classic() +
  labs(x = NULL, y = "Count", title = "Party identification (counts)")
```

---

# Example: proportions 

Same data. Different message.

```{r, message=FALSE, warning=FALSE, fig.width=6, fig.height=3.2}
party_props <- df %>%
  count(party) %>%
  mutate(prop = n / sum(n), party = fct_infreq(party))
ggplot(party_props, aes(x = party, y = prop)) +
  geom_col() +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_classic() +
  labs(x = NULL, y = "Share of respondents", title = "Party identification (proportions)", subtitle = "The denominator is: everyone in the dataset")
```

---

# Example: a pie chart (simple fractions)

Pie charts can work when: (a) there are few categories and (b) the story is about *simple fractions*. They are weak when you need precise comparisons.

```{r, message=FALSE, warning=FALSE, fig.width=5, fig.height=3.6}
ggplot(party_props, aes(x = "", y = prop, fill = party)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_classic() +
  theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
  labs(title = "Party composition (pie chart)")
```

---


# Example: a waffle plot (100 units)

Waffle plots can be a nice alternative to pies when:

- you want a *parts-to-whole* view
- you want the comparison to happen by **counting units** (not angles)

Here: **one square = 1 percentage point**.

We use `theme_void()` because axis ticks carry no information for a waffle grid.

---

# Code waffle plot

```r
waffle_party <- party_props %>%
  mutate(party = fct_infreq(party)) %>%
  arrange(party) %>%
  mutate(pct = floor(prop * 100))
remainder <- 100 - sum(waffle_party$pct)
waffle_party$pct[1] <- waffle_party$pct[1] + remainder
waffle_df <- waffle_party %>%
  select(party, pct) %>%
  tidyr::uncount(weights = pct) %>%
  mutate(
    square = dplyr::row_number(),          # <-- global index across all tiles
    row = (square - 1) %/% 10 + 1,
    col = (square - 1) %% 10 + 1
  )
ggplot(waffle_df, aes(x = col, y = row, fill = party)) +
  geom_tile(color = "white", linewidth = 0.4) +
  coord_equal() +
  scale_y_reverse() +
  scale_fill_brewer(palette = "Set2") +
  theme_void() +
  theme(legend.position = "bottom") +
  labs(title = "Party composition (waffle plot)")
```

---


# Waffle plot

```{r, message=FALSE, warning=FALSE, fig.width=8, fig.height=6.2, echo=FALSE}
waffle_party <- party_props %>%
  mutate(party = fct_infreq(party)) %>%
  arrange(party) %>%
  mutate(pct = floor(prop * 100))

remainder <- 100 - sum(waffle_party$pct)
waffle_party$pct[1] <- waffle_party$pct[1] + remainder

waffle_df <- waffle_party %>%
  select(party, pct) %>%
  tidyr::uncount(weights = pct) %>%
  mutate(
    square = dplyr::row_number(),          # <-- global index across all tiles
    row = (square - 1) %/% 10 + 1,
    col = (square - 1) %% 10 + 1
  )

ggplot(waffle_df, aes(x = col, y = row, fill = party)) +
  geom_tile(color = "white", linewidth = 0.4) +
  coord_equal() +
  scale_y_reverse() +
  scale_fill_brewer(palette = "Set2") +
  theme_void() +
  theme(legend.position = "bottom") +
  labs(title = "Party composition (waffle plot)")
```

---

# Example: higher-contrast waffle colors

`Dark2` is a higher-contrast palette than `Set2`. Use it when: (a) you have fewer categories and (b) you need the groups to separate clearly

```{r, message=FALSE, warning=FALSE, fig.width=5, fig.height=3.2}
ggplot(waffle_df, aes(x = col, y = row, fill = party)) +
  geom_tile(color = "white", linewidth = 0.4) +
  coord_equal() +
  scale_y_reverse() +
  scale_fill_brewer(palette = "Dark2") +
  theme_void() +
  theme(legend.position = "bottom") +
  labs(title = "Party composition (waffle plot, Dark2 palette)")
```

---

# Pause and discuss with a neighbor

You have three views of the same composition:

1) a bar chart
2) a pie chart
3) a waffle plot

**Prompt:**

- Which makes comparison easiest?
- What does the pie chart encourage you to notice?
- What does it make hard to compare?

---


# Data visualization critique

- Take five minutes
  - What relationship is the figure claiming?
  - Is the main comparison happening by **position** or by something less accurate?
  - Does the design help you assess *strength* vs *noise*?
  - What is one concrete improvement?

.center[
<img src="internet_speed_cost.png" style="width:50%;">
]


---


# Example: stacked bars

Here, the *whole* depends on what you want: (a) counts: total respondents in each region and (b) proportions: share within each region

```{r, message=FALSE, warning=FALSE, fig.width=6, fig.height=3.2}
ggplot(df, aes(x = region, fill = party)) +
  geom_bar() +
  theme_classic() +
  labs(x = NULL, y = "Count", title = "Party by region (stacked counts)")
```

---

# Example: normalized stacks

`position = "fill"` changes the y-axis into a **within-x share**.

```{r, message=FALSE, warning=FALSE, fig.width=6, fig.height=3.2}
ggplot(df, aes(x = region, fill = party)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_classic() +
  labs(x = NULL, y = "Share within region", title = "Party by region (normalized stacked bars)", subtitle = "Now the denominator is: respondents within each region")
```

---


# Data visualization critique

- Take five minutes
  - What relationship is the figure claiming?
  - Is the main comparison happening by **position** or by something less accurate?
  - Does the design help you assess *strength* vs *noise*?
  - What is one concrete improvement?

.center[
<img src="pie_chart.png" style="width:65%;">
]

---

# Example: nested proportions

Now the denominator changes *again*. Within each party, how does the attitude breakdown differ by education?

```{r, message=FALSE, warning=FALSE, fig.width=7, fig.height=3.2}
df_nested <- df %>%
  mutate(education = factor(education, levels = c("HS or less", "Some college", "BA", "Graduate"), labels = c("HS/\nless", "Some\ncollege", "BA", "Graduate")),
         party = factor(party, levels = c("Democrat", "Independent", "Republican")))
ggplot(df_nested, aes(x = education, fill = attitude)) +
  geom_bar(position = "fill") +
  facet_wrap(~ party, nrow = 1) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_classic() +
  labs(x = NULL, y = "Share within education (within party)", title = "Nested proportions via small multiples", subtitle = "Each bar sums to 100% within a party panel")
```

---

# Data visualization critique 

- Take five minutes
  - What is the plot comparing: **shape** or **totals**?
  - Do the design choices make comparisons easy?
  - What would change if you used an ECDF instead?
  - After doing this, talk to your neighbor briefly and compare notes.

.center[
<img src="time_spent.png" style="width:65%;">
]


---

# What success looks like

- You can state the denominator in words before you plot.
- You can choose between:
  - counts vs proportions
  - stacked vs side-by-side
  - one plot vs small multiples
- You can explain when a pie chart helps (rarely) and when it hurts.
- You can make nested proportions readable by conditioning (facets).

---


# In-Class Activity

Find a visualization online.

With a neighbor:
- Identify the data variables
- Identify the visual mappings
- Decide what message the plot is making
- Suggest one concrete improvement


---

# What Comes Next

Next, we will practice composition tasks with social data:

- stacked and normalized bars
- nested proportions with conditioning
- short written justifications (what comparison is made easy?)

Focus on clarity, not cleverness.
